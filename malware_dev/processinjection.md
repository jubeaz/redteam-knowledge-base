| üè† [Home](../../pentesting.md) | ‚¨ÖÔ∏è ‚¨ÖÔ∏è [Part](../_part) | ‚¨ÖÔ∏è [Chapter](./_chapter) |
|--------------------------------|----------------------|-------------------------|

-   [Shellcode
    Injection](#shellcode-injection){#toc-shellcode-injection}
    -   [Introduction](#introduction){#toc-introduction}
    -   [DLL Injection](#dll-injection){#toc-dll-injection}
        -   [DLL Injection](#dll-injection-1){#toc-dll-injection-1}
        -   [DLL Sideloading](#dll-sideloading){#toc-dll-sideloading}
    -   [Shellcode Injection](#shellcode-injection-1){#toc-shellcode-injection-1}
        -   [Process Injection](#process-injection){#toc-process-injection}
        -   [CreateRemoteThread](#createremotethread){#toc-createremotethread}
        -   [Process Hollowing](#process-hollowing){#toc-process-hollowing}
        -   [QueueUserAPC \| EarlyBird](#queueuserapc-earlybird){#toc-queueuserapc-earlybird}
    -   [targets of injection](#targets-of-injection){#toc-targets-of-injection}
    -   [links](#links){#toc-links}

# Shellcode Injection

## Introduction

Process injection is an evasion technique which entails running
malicious code within the address space of another process. There are
many ways it can be done, including:

-   **DLL Injection**: write the path of a malicious DLL into the
    address space of a target process and then calls LoadLibrary.

-   **DLL Sideloading**:

-   **Portable Executable Injection**: copie code into the address space
    of a target process and then executes it with CreateRemoteThread.

-   **Process Hollowing**: spawn a target process in a suspended state,
    replaces the entrypoint in memory and then resumes the process.

-   **Thread Execution Hijacking**: suspend a thread in a target
    process, replaces the code and then resumes the thread.

## DLL Injection

### DLL Injection

### DLL Sideloading

[Guide to DLL
Sideloading](https://crypt0ace.github.io/posts/DLL-Sideloading/)

## Shellcode Injection

### Process Injection

Inject into self thread

-   [Shellcode Injection in C# - Part 1 - Process
    Injection](https://crypt0ace.github.io/posts/Shellcode-Injection-Techniques/)

### CreateRemoteThread

There is more than one way to achieve this, but the most common way is
by making use of the following WinAPI functions:

-   [VirtualAllocEx](https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex):
    allocate space in the memory of the target process for our shellcode

-   [WriteProcessMemory](https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory)
    write our shellcode into that allocated space

-   [CreateRemoteThread](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread)
    execute the shellcode in the target process

Note:

-   `lpBaseAddress` of `WriteProcessMemory()` is set with the
    `VirtualAllocEx()` return value

-   `lpStartAddress` of `CreateRemoteThread()` is set with the
    `VirtualAllocEx()` return value

In our case, we will additionally make use of:

-   [CreateProcess](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa)
    to spawn our target process,

-   [VirtualProtectEx](https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotectex)
    to allocate memory with Read/Write memory protection, write the
    shellcode and then set it to Read/Execute before executing.

This is not necessary, but some antivirus solutions find it suspicious
when Read/Write/Execute memory is allocated, so this is a simple
workaround.

### Process Hollowing

-   [The Nightmare of Proc Hollow's
    Exe](https://trustedsec.com/blog/the-nightmare-of-proc-hollows-exe)

-   [Process
    Hollowing](https://ppn.snovvcrash.rocks/red-team/maldev/code-injection/process-hollowing)

-   [OSEP-Code-Snippets](https://github.com/chvancooten/OSEP-Code-Snippets/blob/main/Shellcode%20Process%20Hollowing/Program.cs)

-   **See
    [DinvokeProcessHollow.cs](https://github.com/S3cur3Th1sSh1t/Creds/blob/master/Csharp/DinvokeProcessHollow.cs)
    seems to obfuscate nicely**

-   [HollowGhost](https://github.com/Logan-Elliott/HollowGhost/blob/main/HollowGhost/Program.cs)

### QueueUserAPC \| EarlyBird

-   [Shellcode Injection in C# - Part 3 - QueueUserAPC \|
    EarlyBird](https://crypt0ace.github.io/posts/Shellcode-Injection-Techniques-Part-3/)

## targets of injection

    teams
    msedge
    onedrive
    update executables (????)
    sihost.exe
    spoolsv.exe
    svchost.exe

## links

-   [Ten process injection techniques: A technical survey of common and
    trending process injection
    techniques](https://www.elastic.co/blog/ten-process-injection-techniques-technical-survey-common-and-trending-process)

-   [Process Injection using CreateRemoteThread
    API](https://tbhaxor.com/createremotethread-process-injection/)

-   [Process Injection: Remote Thread Injection or
    CreateRemoteThread](https://aliongreen.github.io/posts/remote-thread-injection.html)

-   [Learning Sliver C2 (07) - Stagers: Process
    Injection](https://dominicbreuker.com/post/learning_sliver_c2_06_stagers_process_injection/)

-   [OffensiveCSharp](https://github.com/matterpreter/OffensiveCSharp)

-   [Writing custom backdoor payloads with
    CSharp](https://github.com/mvelazc0/defcon27_csharp_workshop)

-   [SliverLoader](https://github.com/Cyb3rDudu/SliverLoader/blob/main/README.md)

-   [Code and Process
    Injection](https://www.ired.team/offensive-security/code-injection-process-injection)

-   [OSEP Code
    Snippets](https://github.com/chvancooten/OSEP-Code-Snippets/tree/main)

-   [Windows Process injection in
    2019](https://i.blackhat.com/USA-19/Thursday/us-19-Kotler-Process-Injection-Techniques-Gotta-Catch-Them-All-wp.pdf)
